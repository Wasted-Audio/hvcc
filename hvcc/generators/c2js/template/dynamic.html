<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{name}}</title>

    <!-- Generated javascript library includes -->
    {% for path in includes -%}
    <script type="application/javascript" src="{{path}}"></script>
    {% endfor -%}

    <style>
      .horizontal { display: flex; justify-content: space-evenly; align-items: center; }
      .widget { max-width: 900px; margin: auto; }
      .row { width: 100%; margin-bottom: 10px; }
      .col { display: inline-block; }
      .events { vertical-align: top; margin: 10px; }
      .title { width: 80%; margin: 0 auto; }
      .transport { padding-left: 10px; }
      .parameter-name { width: 35%; text-align: right; }
      .parameter-slider { width: 45%; padding-left: 10px; }
      .parameter-slider input { vertical-align: middle; width: 100%; }
      .parameter-value { width: 10%; padding-left: 10px; text-align: left; }
      .link { margin: 10px 10px 0 0; float: right; }
      span { text-align: right; }
    </style>

    <script type="text/javascript">
      var heavyModule = null;
      var loader = null;
      var sampleOscillator = null;
      var isPlaying = false;
      var midioutPort = null;

      window.onload = function() {
        {{name}}_Module().then(loadedModule => {
          heavyModule = loadedModule;
          moduleLoaded();
        });
        document.getElementById("transportButton").style.visibility = "hidden";
      }

      function moduleLoaded() {
        loader = new heavyModule.AudioLibLoader();
        dynamicallyCreateUI();
        
        loader.init({
          // optional: set audio processing block size, default is 2048
          blockSize: 2048,
          // optional: provide a callback handler for [print] messages
          printHook: onPrint,
          // optional: provide a callback handler for [s {sendName} @hv_param] messages
          // sendName "midiOutMessage" is reserved for MIDI output messages!
          sendHook: null,
          // optional: pass an existing web audio context, otherwise a new one
          // will be constructed.
          webAudioContext: null
        }).then(x => {
          // run once the audio context has been initialised
          addFilterListeners();
        });
        document.getElementById("transportButton").style.visibility = "visible";

        loader.midiOutEvent.onFire = function onMidiOutMessage(message) {
          if (midioutPort !== null) {
            midioutPort.send(message);
          }
          else {
            console.error("No MIDI output port available.");
          }
        }
      }

      function dynamicallyCreateUI() {
        const container = document.querySelector("#container");


        // INPUT EVENTS
        const eventsInKeys = Object.keys(loader.eventsIn);
        const eventsInRow = document.createElement("div");
        container.appendChild(eventsInRow);

        eventsInRow.classList.add("row", "events");
        if (eventsInKeys.length > 0) {
          const eventsCol = document.createElement("div");
          eventsCol.classList.add("col", "events");
          eventsCol.innerHTML = "Input Events:<br>";

          for (const eventKey in loader.eventsIn) {
            const event = loader.eventsIn[eventKey];
            const btn = document.createElement("button");
            btn.innerText = event.displayName;
            btn.addEventListener("click", ()=>{
              event.fire();
            });
            eventsCol.appendChild(btn);
          }

          eventsInRow.appendChild(eventsCol)
        }


        // OUTPUT EVENTS
        const eventsOutKeys = Object.keys(loader.eventsOut);
        if (eventsOutKeys.length > 0) {
          const eventsOutRow = document.createElement("div");
          eventsOutRow.classList.add("row", "events");
          container.appendChild(eventsOutRow);

          const eventsCol = document.createElement("div");
          eventsCol.classList.add("col", "events");
          eventsCol.innerHTML = "Output Events:<br>";

          for (const eventKey in loader.eventsOut) {
            const event = loader.eventsOut[eventKey];
            const counter = document.createElement("span");

            var counterValue = 0;
            counter.innerText = event.displayName + ": " + counterValue;
            event.onFire = function () {
              counterValue++;
              counter.innerText = event.displayName + ": " + counterValue;
            };
            eventsCol.appendChild(counter);
          }

          eventsOutRow.appendChild(eventsCol)
        }


        // INPUT PARAMETERS
        const paramsInKeys = Object.keys(loader.paramsIn);
        if (paramsInKeys.length > 0) {
          const paramsHeaderRow = document.createElement("div");
          paramsHeaderRow.classList.add("row");
          paramsHeaderRow.innerText = "Input Parameters: ";
          container.appendChild(paramsHeaderRow);


          for (const paramKey in loader.paramsIn) {
            const paramsContentRow = document.createElement("div");
            paramsContentRow.classList.add("row");
            const param = loader.paramsIn[paramKey];

            const paramName = document.createElement("div");
            paramName.classList.add("col", "parameter-name");
            paramName.innerText = param.displayName;
            paramsContentRow.appendChild(paramName);

            const paramSliderWrapper = document.createElement("div");
            paramSliderWrapper.classList.add("col", "parameter-slider");
            paramsContentRow.appendChild(paramSliderWrapper);

            const paramSliderDisplay = document.createElement("div");
            paramSliderDisplay.classList.add("col", "parameter-value");
            paramSliderDisplay.innerText = param.value;
            paramsContentRow.appendChild(paramSliderDisplay);

            const paramSlider = document.createElement("input");
            paramSlider.type = "range";
            paramSlider.step = 0.01;
            paramSlider.min = param.min;
            paramSlider.max = param.max;
            paramSlider.value = param.value;
            paramSlider.addEventListener("input", function () {
              param.setValue(paramSlider.value);
              paramSliderDisplay.innerText = param.value;
            });
            paramSliderWrapper.appendChild(paramSlider);

            container.appendChild(paramsContentRow);
          }
        }


        // OUTPUT PARAMS
        const paramsOutKeys = Object.keys(loader.paramsOut);
        if (paramsOutKeys.length > 0) {
          const paramsHeaderRow = document.createElement("div");
          paramsHeaderRow.classList.add("row");
          paramsHeaderRow.innerText = "Output Parameters: ";
          container.appendChild(paramsHeaderRow);

          for (const paramKey in loader.paramsOut) {
            const paramsContentRow = document.createElement("div");
            paramsContentRow.classList.add("row");
            const param = loader.paramsOut[paramKey];

            const paramName = document.createElement("div");
            paramName.classList.add("col", "parameter-name");
            paramName.innerText = param.displayName;
            paramsContentRow.appendChild(paramName);

            const paramSliderWrapper = document.createElement("div");
            paramSliderWrapper.classList.add("col", "parameter-slider");
            paramsContentRow.appendChild(paramSliderWrapper);

            const paramSliderDisplay = document.createElement("div");
            paramSliderDisplay.classList.add("col", "parameter-value");
            paramSliderDisplay.innerText = param.value;
            paramsContentRow.appendChild(paramSliderDisplay);

            const paramSlider = document.createElement("input");
            paramSlider.type = "range";
            paramSlider.step = 0.01;
            paramSlider.min = param.min;
            paramSlider.max = param.max;
            paramSlider.value = param.value;
            paramSlider.disabled = true;
            param.onUpdate = function () {
              paramSlider.value = param.value;
              paramSliderDisplay.innerText = param.value;
            }
            paramSliderWrapper.appendChild(paramSlider);

            container.appendChild(paramsContentRow);
          }
        }
      }

      function start() {
        loader.node.connect(loader.webAudioContext.destination);
        isPlaying = true;
      }

      function stop() {
        loader.node.disconnect(loader.webAudioContext.destination);
        isPlaying = false;
      }

      function toggleTransport(element) {
        (isPlaying) ? stop() : start();
      }

      function onPrint(message) {
        console.log(message);
      }
    {%- if midi | length or midi_out | length %}

      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess()
        .then(onMIDISuccess, onMIDIFailure);
      }

      function onMIDISuccess(midiAccess) {

        {%- if midi | length %}
        
          var midiInputs = [];
          var inputs = midiAccess.inputs.values();
          midiInputs = Array.from(midiAccess.inputs.values());
          var midiInputsSelect = document.getElementById("midiInputs");

          midiInputs.forEach((input, index) => {
            var option = document.createElement("option");
            option.value = index;
            option.text = input.name;
            midiInputsSelect.add(option);
          });

          // Preselect the first MIDI input and output
          if (midiInputs.length > 0) {
            midiInputsSelect.selectedIndex = 0;
            midiInputs[0].onmidimessage = onMIDIMessage;
          }

          midiInputsSelect.onchange = function() {
            var selectedInput = midiInputs[midiInputsSelect.value];
            midiInputs.forEach(input => input.onmidimessage = null); // Clear previous handlers
            selectedInput.onmidimessage = onMIDIMessage;
          };
        {%- endif %}

        {%- if midi_out | length %}
          var midiOutputs = [];
          var outputs = midiAccess.outputs.values();
          midiOutputs = Array.from(midiAccess.outputs.values());
          var midiOutputsSelect = document.getElementById("midiOutputs");

          midiOutputs.forEach((output, index) => {
            var option = document.createElement("option");
            option.value = index;
            option.text = output.name;
            midiOutputsSelect.add(option);
          });

          if (midiOutputs.length > 0) {
            midiOutputsSelect.selectedIndex = 0;
            midioutPort = midiOutputs[0];
          }

          midiOutputsSelect.onchange = function() {
            midioutPort = midiOutputs[midiOutputsSelect.value];
          };
        {%- endif %}
      }

      function onMIDIFailure(msg) {
        console.error(`Failed to get MIDI access - ${msg}`);
      }

      function onMIDIMessage(message) {
        loader.sendMidi(message.data);
      }
    {%- endif %}

      function addFilterListeners() {
        const filePicker = document.querySelector("#filePicker");
        const filePlayer = document.querySelector("#filePlayer");
        filePicker.addEventListener("input", ()=>{
          if (filePicker.files.length > 0) {
            filePlayer.src = URL.createObjectURL(filePicker.files[0]);
            filePlayer.controls = true;
            filePicker.remove();
          }
        });

        const source = loader.webAudioContext.createMediaElementSource(filePlayer);
        source.connect(loader.node);
      }
    </script>
  </head>
  <body>
    <div class="widget" id="container">
      <div class="row title">
        <div class="col"><h2>{{name}}</h2></div>
        <div class="col transport">
          <label>
            start / stop
            <input type="checkbox" id="transportButton" onchange="toggleTransport();">
          </label>
        </div>
      </div>
      <div class="row">
        <div class="col"><h3>Filter input: </h3></div>
        <div class="col">
          <input type="file" accept="audio/*" id="filePicker">
          <audio id="filePlayer"></audio>
        </div>
      </div>

      {%- if midi | length or midi_out | length%}
      <div class="horizontal" style="text-align: center;">
        {%- if midi | length %}
        <div>
          <div>MIDI inputs:</div>
          <select id="midiInputs" onchange="console.log(this.value)"></select>
        </div>
        {%- endif %}
        {%- if midi_out | length %}
        <div>
          <div>MIDI outputs:</div>
          <select id="midiOutputs" onchange="console.log(this.value)"></select>
        </div>
        {%- endif %}
      </div>
      {%- endif %}
      <div class="row">
        <span class="link"><em>powered by <a href="https://github.com/Wasted-Audio/hvcc"><strong>heavy</strong></a></em></span>
        <br>
        <span class="link"><a href="./index.html">classic version</a></span>
      </div>
    </div>
  </body>
</html>
